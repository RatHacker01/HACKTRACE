rule Suspicious_Malware_Behavior
{
    meta:
        description = "Detects malware with anti-VM, AV evasion, reverse shell, and encoding behavior"
        author = "Jigsaw1505"
        date = "2025-05-04"
        version = "1.0"

    strings:
        // Anti-VM functions (commonly found in malware)
        $s1 = "VBoxService" ascii wide
        $s2 = "vmware" ascii wide
        $s3 = "QEMU" ascii wide
        $s4 = "SbieDll.dll" ascii wide   // Sandboxie detection

        // Antivirus bypass indicators
        $s5 = "IsDebuggerPresent" ascii
        $s6 = "NtQueryInformationProcess" ascii
        $s7 = "AVP.exe" ascii wide
        $s8 = "taskkill /F /IM" ascii  // Killing AV processes

        // Reverse shell connection indicators
        $s9 = "cmd.exe /c" ascii
        $s10 = "nc.exe" ascii
        $s11 = "powershell -nop -w hidden -e" ascii
        $s12 = /connect\s+\d{1,3}(\.\d{1,3}){3}/ ascii  // IP connection attempt

        // Malicious domain or C2 patterns
        $s13 = "http://" ascii
        $s14 = "https://" ascii
        $s15 = /[a-z0-9\-\.]+\.(ru|cn|tk|top|xyz)/ ascii  // Suspicious TLDs

        // Changed file extensions (commonly used in ransomware)
        $s16 = ".locked" ascii
        $s17 = ".crypted" ascii
        $s18 = ".enc" ascii

        // Encoding base64 or obfuscation signs
        $s19 = "base64_decode" ascii
        $s20 = "FromBase64String" ascii

    condition:
        6 of ($s*) or
        all of ($s1, $s2, $s3, $s4) or
        all of ($s9, $s10, $s11) or
        all of ($s19, $s20)
        (any of ($s13, $s14, $s15) and any of ($s16, $s17, $s18))
}
